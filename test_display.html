<!DOCTYPE html>
<html>
<head>
    <title>Test Deontic Display</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        table { border-collapse: collapse; width: 100%; margin: 20px 0; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        th { background-color: #f2f2f2; }
        .status-blocked { background-color: #DB0011; color: white; padding: 4px 8px; border-radius: 3px; }
        .status-allowed { background-color: #00A758; color: white; padding: 4px 8px; border-radius: 3px; }
        .rule-blocked { background-color: #ffebee; }
        pre { background: #f5f5f5; padding: 10px; overflow-x: auto; }
    </style>
</head>
<body>
    <h1>Deontic API Display Test</h1>

    <h2>Test 1: US → China (should show prohibition)</h2>
    <div id="test1"></div>

    <h2>Test 2: Ireland → Poland (should show permissions)</h2>
    <div id="test2"></div>

    <script>
        async function testAPI() {
            // Test 1: US → China
            const response1 = await fetch('http://localhost:5001/api/evaluate-rules', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    origin_country: 'United States',
                    receiving_country: 'China',
                    has_pii: false
                })
            });
            const data1 = await response1.json();
            document.getElementById('test1').innerHTML = `
                <pre>${JSON.stringify(data1, null, 2)}</pre>
                ${displayRules(data1.triggered_rules)}
            `;

            // Test 2: Ireland → Poland
            const response2 = await fetch('http://localhost:5001/api/evaluate-rules', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    origin_country: 'Ireland',
                    receiving_country: 'Poland',
                    has_pii: true
                })
            });
            const data2 = await response2.json();
            document.getElementById('test2').innerHTML = `
                <pre>${JSON.stringify(data2, null, 2)}</pre>
                ${displayRules(data2.triggered_rules)}
            `;
        }

        function displayRules(rules) {
            if (!rules || rules.length === 0) {
                return '<p>No rules</p>';
            }

            let html = '<table><thead><tr>';
            html += '<th>Rule ID</th><th>Type</th><th>Status</th><th>Description</th><th>Action</th><th>Duties</th>';
            html += '</tr></thead><tbody>';

            rules.forEach(rule => {
                const hasProhibition = rule.prohibition || rule.is_blocked;
                const hasPermission = rule.permission;

                let type = '-';
                let status = 'UNKNOWN';
                let statusBadge = '';
                let dutiesStr = 'None';
                let rowClass = '';

                if (hasProhibition) {
                    type = 'Prohibition';
                    status = 'BLOCKED';
                    statusBadge = '<span class="status-blocked">PROHIBITED</span>';
                    rowClass = 'rule-blocked';

                    if (rule.prohibition && rule.prohibition.duties && rule.prohibition.duties.length > 0) {
                        dutiesStr = rule.prohibition.duties.map(d => d.name).join('; ');
                    } else {
                        dutiesStr = 'Prohibited - no exceptions';
                    }
                } else if (hasPermission) {
                    type = 'Permission';
                    status = 'ALLOWED';
                    statusBadge = '<span class="status-allowed">ALLOWED</span>';

                    if (rule.permission && rule.permission.duties && rule.permission.duties.length > 0) {
                        dutiesStr = rule.permission.duties.map(d => {
                            if (d.module) {
                                return `${d.name} (${d.module}: ${d.value})`;
                            }
                            return d.name;
                        }).join('; ');
                    }
                }

                const action = rule.action ? rule.action.name : '-';

                html += `<tr class="${rowClass}">`;
                html += `<td><strong>${rule.rule_id}</strong></td>`;
                html += `<td>${type}</td>`;
                html += `<td>${statusBadge}</td>`;
                html += `<td>${rule.description}</td>`;
                html += `<td>${action}</td>`;
                html += `<td>${dutiesStr}</td>`;
                html += '</tr>';
            });

            html += '</tbody></table>';
            return html;
        }

        testAPI();
    </script>
</body>
</html>
